#!/usr/bin/env bash
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
  echo -e "${RED}Error: $1${NC}" >&2
  exit 1
}

info() {
  echo -e "${GREEN}$1${NC}"
}

warn() {
  echo -e "${YELLOW}$1${NC}"
}

# Check argument
if [ $# -ne 1 ]; then
  echo "Usage: $0 <patch|minor|major>"
  echo ""
  echo "Examples:"
  echo "  $0 patch   # 0.17.0 -> 0.17.1"
  echo "  $0 minor   # 0.17.0 -> 0.18.0"
  echo "  $0 major   # 0.17.0 -> 1.0.0"
  exit 1
fi

BUMP_TYPE="$1"

if [[ "$BUMP_TYPE" != "patch" && "$BUMP_TYPE" != "minor" && "$BUMP_TYPE" != "major" ]]; then
  error "Invalid bump type: $BUMP_TYPE. Must be one of: patch, minor, major"
fi

# Check we're on master branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "master" ]; then
  error "Must be on master branch (currently on: $CURRENT_BRANCH)"
fi

# Check for pristine git status
if [ -n "$(git status --porcelain)" ]; then
  error "Working directory is not clean. Commit or stash your changes first.\n$(git status --short)"
fi

# Check we're up to date with remote
git fetch origin master --quiet
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/master)
if [ "$LOCAL" != "$REMOTE" ]; then
  error "Local master is not up to date with origin/master. Run 'git pull' first."
fi

# Get current version
CURRENT_VERSION=$(node -p "require('./package.json').version")
info "Current version: $CURRENT_VERSION"

# Calculate new version
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

case "$BUMP_TYPE" in
  major)
    NEW_VERSION="$((MAJOR + 1)).0.0"
    ;;
  minor)
    NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
    ;;
  patch)
    NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
    ;;
esac

info "New version: $NEW_VERSION"

# Check tag doesn't already exist
if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
  error "Tag $NEW_VERSION already exists"
fi

# Confirm with user
echo ""
warn "This will:"
echo "  1. Update package.json version to $NEW_VERSION"
echo "  2. Commit the change"
echo "  3. Create tag $NEW_VERSION"
echo "  4. Push to origin (commit + tag)"
echo ""
read -p "Continue? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

# Update package.json version
info "Updating package.json..."
npm version "$NEW_VERSION" --no-git-tag-version --allow-same-version

# Commit
info "Committing..."
git add package.json
git commit -m "Bump to $NEW_VERSION"

# Create tag
info "Creating tag $NEW_VERSION..."
git tag "$NEW_VERSION"

# Push
info "Pushing to origin..."
git push origin master
git push origin "$NEW_VERSION"

echo ""
info "Release $NEW_VERSION complete!"
echo "GitHub Actions will now build, test, and publish to npm."
echo "Monitor the release at: https://github.com/enspirit/emb/actions"
